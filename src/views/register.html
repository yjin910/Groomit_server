<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
	<!-- Javascript SDK-->
	<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script> 
	<script src="js/amazon-cognito-auth.min.js"></script>
	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script> 
	<script src="js/amazon-cognito-identity.min.js"></script>  
	<script src="js/config.js"></script>
	<link rel="stylesheet" type="text/css" href="register_style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link href='https://fonts.googleapis.com/css?family=Titillium+Web:400,300,600' rel='stylesheet' type='text/css'>  
</head>

	
<body>
	<img src="groomit_logo.png" alt="Groomit logo" onclick="window.location.href='login.html'" width="160" height="60">
	<div class="login-page">
		<form class="form">
			<form class="form">
				<h2 class="h3 mb-3 font-weight-normal" id="titleheader">Register an Account</h1>
				<input type="personalname" class="form-control" id="signup_name" placeholder="Name" pattern=".*" required>
				<input type="email" class="form-control" id="signup_email" placeholder="Email" pattern=".*" required>
				<input type="password" class="form-control" id="signup_pwd" placeholder="Password" pattern=".*" required>
				<confirm class="message" id="message"></confirm>
				<button id="confirmemail" type="button" onclick="registerButton()">Get Verifications Code</button>
				<button id="reconfirmemail" type="button" onclick="resendVerification()" style="display:none">Resend Verifications Code</button>
				<input class="form-control" id="verificationCode" placeholder="Verification code">
				<button id="verify" type="button" onclick="veryfyAccount()">Verify Account</button>
		</form>
	</div>

	<!-- "window.location.href='login.html';" -->
	<script>
		/// <reference types="aws-sdk" />

		var user_Email;
		var user_Pw;
		var user_Name;
		var cognitoUser;
		
		var poolData = {
					UserPoolId : _config.cognito.userPoolId,
					ClientId : _config.cognito.clientId
				};

		function registerButton() {
			var email_reg = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
			user_Email = document.getElementById("signup_email").value;
			user_Pw =  document.getElementById("signup_pwd").value;	
			user_Name =  document.getElementById("signup_name").value;	
			
			if (!email_reg.test(user_Email)){
				document.getElementById("message").innerHTML = "*** Invalid email";
			} else {
				sendEmailVaification()
			}
		}
		function sendEmailVaification(){		
			userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
			var attributeList = [];
			
			var dataEmail = {
				Name : 'email', 
				Value : user_Email
			};
		
			var dataPersonalName = {
				Name : 'name', 
				Value : user_Name, //get from form field
			};
			
			var attributeEmail = new AmazonCognitoIdentity.CognitoUserAttribute(dataEmail);
			var attributePersonalName = new AmazonCognitoIdentity.CognitoUserAttribute(dataPersonalName);
			
			attributeList.push(attributeEmail);
			attributeList.push(attributePersonalName);
			userPool.signUp(user_Email, user_Pw, attributeList, null, function(err, result){
				if (err) {
					alert(err.message || JSON.stringify(err));
					return;
				}
				cognitoUser = result.user;
				console.log('user name is ' + cognitoUser.getUsername());
				//change elements of page
				document.getElementById("message").innerHTML = "Check your email for a verification link";
				document.getElementById("confirmemail").style.display = "none";
				document.getElementById("reconfirmemail").style.display = "";
			});
		}

		function resendVerification(){
			var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

            var userData = {
                Username: user_Email,
                Pool: userPool,
            };
			
			cognitoUser.resendConfirmationCode(function(err, result) {
				if (err) {
					alert(err.message || JSON.stringify(err));
					return;
				}
				document.getElementById("message").innerHTML = "Recheck your email for a verification link";
			});
		}	

		function veryfyAccount(){

			var poolData = {
                UserPoolId: _config.cognito.userPoolId, // Your user pool id here
                ClientId: _config.cognito.clientId, // Your client id here
            };

            var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

            var userData = {
                Username: user_Email,
                Pool: userPool,
            };

			var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
			var code = document.getElementById("verificationCode").value;

			cognitoUser.confirmRegistration(code, true, function(err, result) {
				if (err) {
					alert(err.message || JSON.stringify(err));
					return;
				}
				if(result == "SUCCESS"){
					console.log('call result: ' + result);
					window.location.href = "successRegister.html"
				}else{
					document.getElementById("message").innerHTML = "Wrong verification code!";
				}
			});
        }
	</script>
 
 </body>
  
</html>