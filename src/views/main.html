<!DOCTYPE html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
    <script src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
    <script src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script src="js/amazon-cognito-identity.min.js"></script>
    <script src="js/config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="lightpick.js"></script>  
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,700i&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="lightpick.css">  
    <link rel="stylesheet" type="text/css" href="main.css">
</head>

<body>
    <div class="info">
        <img class="logo_groomit" src="groomit_logo.png" alt="Groomit logo" onclick="window.location.href='login.html'">
        무선 방사능 및 온습도 측정시스템
        <button type="button" class="member_info" onclick="logOut()">Log out</button>
        <button type="button" class="member_info" onclick="window.location.href='profile.html' ;">Profile</button>
    </div>


    <!-- select device -->
    <div class="data_info">
        <select id="devices" onchange="changeGraph(this.value)"></select>

        <!-- select term -->
        <input type="radio" name="date" value="24" onclick="changeDate()"> 1일</input>
        <input type="radio" name="date" value="168" onclick="changeDate()"> 1주일</input>
        <input type="radio" name="date" value="720" onclick="changeDate()"> 1달</input>
        <input type="text" id="datepicker"/>

        <button type="submit" onclick="json2csv()">Download!</button>
    </div>

    <!-- buttons for logout or see profile -->
    <div class="container">
        <div id="graph">
            <canvas id="canvasG"></canvas>
        </div>
    </br>
        <div id="graph">
            <canvas id="canvasT"></canvas>
        </div>
    </br>
        <div id="graph">
            <canvas id="canvasH"></canvas>
        </div>
    </br>
    </div>
    <footer> Technonia </footer>
    <script>
            var uuid;
            var email;
            var datas;
            var c_val = 'gth';
            var gChart, tChart, hChart;

            var picker = new Lightpick({
                field: document.getElementById('datepicker'),
                singleDate: false,
                onSelect: function(start, end){
                    var str = '';
                    str += start ? start.format('Do MMMM YYYY') + ' to ' : '';
                    str += end ? end.format('Do MMMM YYYY') : '...';
                    document.getElementById('result-2').innerHTML = str;
                }
            });

            var data = {
                UserPoolId: _config.cognito.userPoolId,
                ClientId: _config.cognito.clientId
            };
            var userPool = new AmazonCognitoIdentity.CognitoUserPool(data);
            var cognitoUser = userPool.getCurrentUser();

            if (cognitoUser != null) {
                cognitoUser.getSession(function(err, session) {
                    if (err) {
                        alert(err);
                        return;
                    }
                    console.log('session validity: ' + session.isValid());
                    //Set the profile info
                    cognitoUser.getUserAttributes(function(err, result) {
                        if (err) {
                            console.log(err);
                            return;
                        }
                        console.log(result);
                        email = result[3].getValue();
                        console.log(email)
                        getGraph();
                    });
                });
            }

            function logOut() {
                if (cognitoUser != null) {
                    cognitoUser.signOut();
                    window.location.href = 'login.html';
                }
            }

            function getGraph() {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '/main/mainUuid?email=' + email); // 메소드와 주소 설정
                xhr.onreadystatechange = function() { // 요청에 대한 콜백
                    if (xhr.readyState === xhr.DONE) { // 요청이 완료되면
                        if (xhr.status === 200 || xhr.status === 201) {
                            // 메인 uuid설정란 db에 만들기?
                            var uuids = JSON.parse(xhr.responseText);
                            console.log(uuids.length)
                            if (uuids.length == 0) {
                                uuid = null;
                            } else {
                                uuid = uuids[0].deviceNum;
                                addSelection(uuids);
                                getGraphData();
                            }
                        } else {
                            console.error(xhr.responseText);
                        }
                    }
                };
                xhr.send();
            }

            function getGraphData(term) {
                let tempURL = '/main/graphInfo?u=' + uuid + '&type=' + c_val;
                if (term) tempURL += ('&term=' + term);
                var xhr = new XMLHttpRequest();
                xhr.open('GET', tempURL); // 메소드와 주소 설정
                xhr.onreadystatechange = function() { // 요청에 대한 콜백
                    if (xhr.readyState === xhr.DONE) { // 요청이 완료되면
                        if (xhr.status === 200 || xhr.status === 201) {
                            // console.log(JSON.parse(xhr.responseText));
                            // console.log(startD)
                            datas = JSON.parse(xhr.responseText);
                            sortdata();
                        } else {
                            console.error(xhr.responseText);
                        }
                    }
                };
                xhr.send();
            }

            function sortdata() {
                var labels = [];
                var g_data = [];
                var t_data = [];
                var h_data = [];

                for (key in datas) {
                    // console.log(datas[key].type)
                    type = datas[key].type;
                    CDate = new Date(datas[key].time);
                    value = datas[key].val;

                    if (type == 'g') {
                        g_data.push({
                            x: CDate,
                            y: value
                        })
                    }
                    if (type == 't') {
                        t_data.push({
                            x: CDate,
                            y: value
                        })
                    }
                    if (type == 'h') {
                        h_data.push({
                            x: CDate,
                            y: value
                        })
                    }
                    if (!labels.includes(new Date(datas[key].time))) {
                        labels.push(CDate)
                    }
                }
                // console.log(g_data)
                drawGraph(c_val, labels, g_data, t_data, h_data);
            }

            function drawGraph(c_val, labels, g_data, t_data, h_data) {
                // console.log(g_data)
                const DATASET_G = {
                    label: 'geiger count',
                    data: g_data,
                    backgroundColor: window.chartColors.red,
                    borderColor: window.chartColors.red,
                    type: 'line',
                    pointRadius: 0,
                    fill: false,
                    lineTension: 0,
                    borderWidth: 1,
                }

                const DATASET_T = {
                    label: 'temperature',
                    data: t_data,
                    backgroundColor: window.chartColors.blue,
                    borderColor: window.chartColors.blue,
                    type: 'line',
                    pointRadius: 0,
                    fill: false,
                    lineTension: 0,
                    borderWidth: 1,
                }

                const DATASET_H = {
                    label: 'humidity',
                    data: h_data,
                    backgroundColor: window.chartColors.orange,
                    borderColor: window.chartColors.orange,
                    type: 'line',
                    pointRadius: 0,
                    fill: false,
                    lineTension: 0,
                    borderWidth: 1,
                }

                let dataset_arr_g = [];
                let dataset_arr_t = [];
                let dataset_arr_h = [];

                if (c_val.includes("g")) {
                    dataset_arr_g.push(DATASET_G);
                    getGgraph(labels, dataset_arr_g);
                }
                if (c_val.includes("t")) {
                    dataset_arr_t.push(DATASET_T);
                    getTgraph(labels, dataset_arr_t);
                }
                if (c_val.includes("h")) {
                    dataset_arr_h.push(DATASET_H);
                    getHgraph(labels, dataset_arr_h)
                }        
            }

            function getGgraph(labels, dataset_arr_g) {
                var config_g = {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: dataset_arr_g
                    },
                    options: {
                        legend:{
                            display:false
                        },
                        responsive: true,
                        title: {
                            display: true,
                            text: 'Geiger',
                            fontSize: 20
                        },
                        scales: {
                            xAxes: [{
                                type: "time",
                                time: {
                                    parser: "MM/DD/YYYY HH:mm",
                                    tooltipFormat: "ll HH:mm"
                                },
                                ticks: {
                                    maxRotation: 0
                                },
                                distribution: 'series',
                                display: true,
                            }],
                            yAxes: [{
                                type: 'linear',
                                display: true,
                            }]
                        }
                    }
                };

                if (gChart){
                    gChart.destroy();
                }
                var ctx_g = document.getElementById('canvasG').getContext('2d');
                gChart = new Chart(ctx_g, config_g);
                gChart.update();
            }

            function getTgraph(labels, dataset_arr_t) {
                var config_t = {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: dataset_arr_t
                    },
                    options: {
                        legend:{
                            display:false
                        },
                        responsive: true,
                        title: {
                            display: true,
                            text: 'Temperature',
                            fontSize: 20
                        },
                        scales: {
                            xAxes: [{
                                type: "time",
                                time: {
                                    parser: "MM/DD/YYYY HH:mm",
                                    tooltipFormat: "ll HH:mm"
                                },
                                ticks: {
                                    maxRotation: 0
                                },
                                distribution: 'series',
                                display: true,
                            }],
                            yAxes: [{
                                type: 'linear',
                                display: true,
                            }]
                        }
                    }
                };

                if (tChart){
                    tChart.destroy();
                }
                var ctx_t = document.getElementById('canvasT').getContext('2d');
                tChart = new Chart(ctx_t, config_t);
                tChart.update();
            }

            function getHgraph(labels, dataset_arr_h) {
                var config_h = {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: dataset_arr_h
                    },
                    options: {
                        legend:{
                            display:false
                        },
                        responsive: true,
                        title: {
                            display: true,
                            text: 'Humidity',
                            fontSize: 20
                        },
                        scales: {
                            xAxes: [{
                                type: "time",
                                time: {
                                    parser: "MM/DD/YYYY HH:mm",
                                    tooltipFormat: "ll HH:mm"
                                },
                                ticks: {
                                    maxRotation: 0
                                },
                                distribution: 'series',
                                display: true,
                            }],
                            yAxes: [{
                                type: 'linear',
                                display: true,
                            }]
                        }
                    }
                };

                if (hChart){
                    hChart.destroy();
                }
                var ctx_h = document.getElementById('canvasH').getContext('2d');
                hChart = new Chart(ctx_h, config_h);
                hChart.update();
            }

            function addSelection(uuids) {
                var selection = document.getElementById("devices");
                console.log(selection.length)
                if (selection.length == 0) {
                    for (i in uuids) {
                        var option = document.createElement("option");

                        option.text = uuids[i].deviceNum;
                        option.value = uuids[i].deviceNum;
                        selection.add(option)
                        console.log(uuids[i])
                    }
                } else if (uuids.length > selection.length) {
                    // TODO:: 추가시 어떻게 할지 확인
                }
            }

            function changeGraph(device) {
                uuid = device;
                getGraphData()
            }


            function changeDate() {
                var date = document.getElementsByName('date');

                for( i=0; i<date.length; i++ ) {
                    if(date[i].checked) {
                        var checked_value = date[i].value;
                        getGraphData(checked_value);
                    }
                }
            }

            function json2csv() {
                var array = typeof datas != 'object' ? JSON.parse(datas) : datas;
                var str = '';
                var line = '';

                var head = array[0];

                for (var index in array[0]) {
                    var value = index + "";
                    line += '"' + value.replace(/"/g, '""') + '",';
                }

                line = line.slice(0, -1);
                str += line + '\r\n';

                for (var i = 0; i < array.length; i++) {
                    var line = '';

                    for (var index in array[i]) {
                        var value = array[i][index];

                        if (value == (array[i].time)){
                            value = new Date(value) + "";
                        }else{
                            value = value + "";
                        }
                        // if(value == array[i].)
                        line += '"' + value.replace(/"/g, '""') + '",';
                    }

                    line = line.slice(0, -1);
                    str += line + '\r\n';
                }

                var hiddenElement = document.createElement('a');
                hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(str);
                hiddenElement.target = '_blank';
                hiddenElement.download = uuid + '.csv';
                hiddenElement.click();
                // window.open("data:text/csv;charset=utf-8," + escape(str));
            }
        </script>
</body>
</html>