<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
    <script src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
    <script src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script src="js/amazon-cognito-identity.min.js"></script>  
    <script src="js/config.js"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>
<body>
    <img src="groomit_logo.png" alt="Groomit logo" onclick="window.location.href='login.html'" width="160" height="60">
    <img src="technonia_logo.png" alt="Technonia logo" onclick="window.location.href='login.html'" width="150" height="20">

    <h2>Main Page</h2>

    <!-- select device -->
    <div class="devices">
            <select id="devices" onchange="changeGraph(this.value)">
                <option value=''>기기 선택 list box</option>
            </select>
    </div>

    <!-- select term -->
    <form action="/action_page.php">
        조회기간 선택 ( 시작~종료 )  : <input type="date" name="bday">
        <input type="submit">
    </form>
    
    <!-- buttons for logout or see profile -->
    <div class="container">
            <div>
            <button type="button" onclick="signOut()">Sign out</button>
            <button type="button" onclick="window.location.href='profile.html';">Profile</button>
            </div>
    <div>

    <!-- graph for giger -->
    <div style="width:75%;">
        <canvas id="canvasG"></canvas>
    </div>

    <!-- graph for temperature and humadity -->
    <div style="width:75%;">
        <canvas id="canvasTH"></canvas>
    </div>

<script>
        var uuid;
        var email;
        var c_val = 'gth';
        
        var data = { 
            UserPoolId : _config.cognito.userPoolId,
            ClientId : _config.cognito.clientId
        };
        var userPool = new AmazonCognitoIdentity.CognitoUserPool(data);
        var cognitoUser = userPool.getCurrentUser();
        
        if (cognitoUser != null) {
			cognitoUser.getSession(function(err, session) {
				if (err) {
					alert(err);
					return;
				}
				console.log('session validity: ' + session.isValid());
				//Set the profile info
				cognitoUser.getUserAttributes(function(err, result) {
					if (err) {
						console.log(err);
						return;
					}
					console.log(result);
                    email = result[3].getValue();
                    console.log(email)
                    getGraph()
                });					
			});
		}

        function signOut(){
            if(cognitoUser != null){
                cognitoUser.signOut();
                window.location.href = 'login.html';
            }
        }

        function getGraph(){
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/main/:mainUuid?email=' + email); // 메소드와 주소 설정
            xhr.onreadystatechange = function () { // 요청에 대한 콜백
                if (xhr.readyState === xhr.DONE) { // 요청이 완료되면
                    if (xhr.status === 200 || xhr.status === 201) {
                        // 메인 uuid설정란 db에 만들기?
                        var uuids = JSON.parse(xhr.responseText);
                        console.log(uuids.length)
                        if (uuids.length == 0){
                            uuid = null;
                        }else{
                            uuid = uuids[0].deviceNum;
                            addSelection(uuids);
                            getGraphData();
                        }
                    } else {
                        console.error(xhr.responseText);
                    }
                }
            };
            xhr.send();
        }

        function getGraphData(){
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/main/:graphInfo?u=' + uuid + '&type=' + c_val); // 메소드와 주소 설정
            xhr.onreadystatechange = function () { // 요청에 대한 콜백
                if (xhr.readyState === xhr.DONE) { // 요청이 완료되면
                    if (xhr.status === 200 || xhr.status === 201) {
                        // console.log(JSON.parse(xhr.responseText));
                        var datas = JSON.parse(xhr.responseText);

                        sortdata(datas);
                    } else {
                        console.error(xhr.responseText);
                    }
                }
            };
            xhr.send();
        }

        function sortdata(datas) {
            var labels = [];
            var g_data = [];
            var t_data = [];
            var h_data = [];

            for(key in datas) {
                // console.log(datas[key].type)
                type = datas[key].type;
                CDate = new Date(datas[key].time);
                value = datas[key].val;

                if(type == 'g'){
                    g_data.push({x : CDate, y : value})
                }
                if(type == 't'){
                    t_data.push({x : CDate, y : value})
                }
                if(type == 'h'){
                    h_data.push({x : CDate, y : value})
                }
                if (!labels.includes(new Date(datas[key].time))){
                    labels.push(CDate)
                }
            }
            // console.log(g_data)
            drawGraph(c_val, labels, g_data, t_data, h_data);
        }
    
            function drawGraph(c_val, labels, g_data, t_data, h_data){
                // console.log(g_data)
                const DATASET_G = {
                            label: 'geiger count',
                            data: g_data,
                            backgroundColor: window.chartColors.red,
                            borderColor: window.chartColors.red,
                            type: 'line',
					        pointRadius: 0,
                            fill: false,
                            lineTension: 0,
					        borderWidth: 1,
                        }

                const DATASET_T = {
                            label: 'temperature',
                            data: t_data,
                            backgroundColor: window.chartColors.blue,
                            borderColor: window.chartColors.blue,
                            type: 'line',
					        pointRadius: 0,
                            fill: false,
                            lineTension: 0,
					        borderWidth: 1,
                        }

                const DATASET_H = {
                            label: 'humidity',
                            data: h_data,
                            backgroundColor: window.chartColors.orange,
                            borderColor: window.chartColors.orange,
                            type: 'line',
					        pointRadius: 0,
                            fill: false,
                            lineTension: 0,
					        borderWidth: 1,
                        }
                
                let dataset_arr_g = [];
                let dataset_arr_th = []

                if (c_val.includes("g")){
                    dataset_arr_g.push(DATASET_G);
                    getGgraph(labels, dataset_arr_g);
                }
                if (c_val.includes("t") || c_val.includes("h")){
                    if(c_val.includes("t")){
                    dataset_arr_th.push(DATASET_T);
                    }
                    if(c_val.includes("h")){
                        dataset_arr_th.push(DATASET_H);
                    }
                    getTHgraph(labels, dataset_arr_th);
                }
            }

            function getGgraph(labels, dataset_arr_g){
                var config_g = {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: dataset_arr_g
                    },
                    options: {
                        responsive: true,
                        title: {
                            display: true,
                            text: 'G_graph of device: ' + uuid
                        },
                        scales: {
                            xAxes: [{
                                type: 'time',
                                // time: {
                                    // unit: 'second',
                                    // displayFormats: {
                                    //     month: 'MMM YYYY'
                                    // }
                                // },
                                distribution: 'series',
                                display: true,
                            }],
                            yAxes: [{
                                display: true,
                                type: 'linear',
                            }]
                        }
                    }
                };

                var ctx_g = document.getElementById('canvasG').getContext('2d');
                window.myLine = new Chart(ctx_g, config_g);
                window.myLine.update();
            }

            function getTHgraph(labels, dataset_arr_th){
                var config_th = {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: dataset_arr_th
                    },
                    options: {
                        responsive: true,
                        title: {
                            display: true,
                            text: 'T&H_raph of device: ' + uuid
                        },
                        scales: {
                            xAxes: [{
                                type:       "time",
                                time:       {
                                    parser: 'DD h:mm a',
                                    tooltipFormat: 'll'
                                },
                                scaleLabel: {
                                    display:     true,
                                    labelString: 'Date'
                                },
                                distribution: 'series',
                                display: true,
                            }],
                            yAxes: [{
                                display: true,
                                type: 'linear',
                                labelString: 'value'
                            }]
                        }
                    }
                };

                var ctx_th = document.getElementById('canvasTH').getContext('2d');
                window.myLine = new Chart(ctx_th, config_th);
                window.myLine.update();
            }

            function addSelection(uuids){
                var selection = document.getElementById("devices");

                if(selection.length == 1){
                    for (i in uuids){
                        var option = document.createElement("option");

                        option.text = uuids[i].deviceNum;
                        option.value = uuids[i].deviceNum;
                        selection.add(option)
                        console.log(uuids[i].deviceNum)
                    }
                } else if(uuids.length > selection.length){
                    // TODO:: 추가시 어떻게 할지 확인
                }
            }

            function changeGraph(device){
                uuid = device;
                getGraphData()
            }
    </script>
</body>
</html> 
